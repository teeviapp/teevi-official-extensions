var teevi=(function(){"use strict";const l="https://api.themoviedb.org/3",k="https://image.tmdb.org/t/p",m=(()=>{var o;const e=(o=globalThis.Teevi)==null?void 0:o.getInputValueById("api.token");if(e)return e;throw new Error("API token is not defined")})();async function _(e,o,a){const t=new URL(`${l}/search/${o}`);t.searchParams.append("query",e),t.searchParams.append("include_adult","false"),t.searchParams.append("language",a),t.searchParams.append("page","1");const n=await fetch(t.toString(),{method:"GET",headers:{accept:"application/json",Authorization:`Bearer ${m}`}});if(!n.ok)throw new Error(`Failed to fetch shows for query ${e}`);return(await n.json()).results}async function E(e,o,a){const t=new URL(`${l}/${o}/${e}`);t.searchParams.append("language",a);const n=await fetch(t.toString(),{method:"GET",headers:{accept:"application/json",Authorization:`Bearer ${m}`}});if(!n.ok)throw new Error(`Failed to fetch show details for ${o}:${e}`);return n.json()}async function R(e,o,a){const t=new URL(`${l}/tv/${e}/season/${o}`);t.searchParams.append("language",a);const n=await fetch(t.toString(),{method:"GET",headers:{accept:"application/json",Authorization:`Bearer ${m}`}});if(!n.ok)throw new Error(`Failed to fetch season details for ${e} season ${o}`);return await n.json()}async function U(e,o,a,t){const n=new URL(`${l}/${o}/${e}/images`);n.searchParams.append("language",a),t.length>0&&n.searchParams.append("include_image_language",t.join(","));const s=await fetch(n.toString(),{method:"GET",headers:{accept:"application/json",Authorization:`Bearer ${m}`}});if(!s.ok)throw new Error(`Failed to fetch images for ${o}:${e}: ${s.status} ${s.statusText}`);return s.json()}function g(e,o){return`${k}/${{poster:"w500",logo:"w500",backdrop:"w780",still:"w300"}[o]}/${e}`}async function L(e,o,a){const t=new URL(`${l}/${o}/${e}/recommendations`);t.searchParams.append("language",a),t.searchParams.append("page","1");const n=await fetch(t.toString(),{method:"GET",headers:{accept:"application/json",Authorization:`Bearer ${m}`}});if(!n.ok)throw new Error(`Failed to fetch recommendations for show ID ${e}: ${n.status} - ${n.statusText}`);return(await n.json()).results}async function j(e,o,a){let t;switch(a.sorting){case"popularity":t=a.ascending?"popularity.asc":"popularity.desc";break;case"rating":t=a.ascending?"vote_average.asc":"vote_average.desc";break;case"release_date":e=="movie"?t=a.ascending?"primary_release_date.asc":"primary_release_date.desc":t=a.ascending?"first_air_date.asc":"first_air_date.desc";break}async function n(p){const u=new URL(`${l}/discover/${e}`);u.searchParams.append("language",o??"en"),u.searchParams.append("page",String(p)),u.searchParams.append("vote_count.gte",String(a.minimumUserVotes)),t&&u.searchParams.append("sort_by",t);const f=await fetch(u.toString(),{method:"GET",headers:{accept:"application/json",Authorization:`Bearer ${m}`}});if(!f.ok)throw new Error(`Failed to fetch shows from discover at page ${p}: ${f.status} - ${f.statusText}`);return f.json()}let s=1,h=1;const v=a.maximumPages,d=[];for(;s<=h&&s<=v;){const p=await n(s);d.push(...p.results),s++,h=p.total_pages}return d}const c=()=>Teevi.language??"en-US";function $(e){if("release_date"in e&&e.release_date)return e.release_date;if("first_air_date"in e&&e.first_air_date)return e.first_air_date}function w(e){const o="title"in e?"movie":"tv",a=$(e);return{kind:o==="movie"?"movie":"series",id:`${o}/${e.id.toString()}`,title:"title"in e?e.title:e.name,posterURL:g(e.poster_path,"poster"),year:a?new Date(a).getFullYear():void 0}}async function B(e){const[o,a]=await Promise.all([_(e,"movie",c()),_(e,"tv",c())]);return[...o,...a].filter(t=>$(t)!=null&&(t.vote_average??0)>0).sort((t,n)=>n.popularity-t.popularity).map(t=>w(t))}async function F(e){var y,P,S,b,T;const o=r=>{if(!r)return;const i=r.toLowerCase();if(["in production","post production","planned","pilot","rumored","announced"].includes(i))return"upcoming";if(i==="returning series")return"airing";if(i==="canceled")return"canceled";if(i==="released"||i==="ended")return"ended"},[a,t]=e.split("/");if(a!=="movie"&&a!=="tv")throw new Error(`Invalid showId format: ${e}. Expected format: "movie/123" or "tv/456"`);const n=await E(t,a,c()),s=await U(t,a,c(),["en","null"]),h=(y=s.logos.sort((r,i)=>i.vote_average-r.vote_average).find(r=>!r.file_path.endsWith("svg")))==null?void 0:y.file_path,v=(P=s.posters.sort((r,i)=>i.vote_average-r.vote_average).find(r=>!r.iso_639_1&&!r.file_path.endsWith("svg")))==null?void 0:P.file_path,d=a==="movie",p=d?n.runtime:((S=n.episode_run_time)==null?void 0:S[0])||((b=n.last_episode_to_air)==null?void 0:b.runtime),u=d?n.release_date:n.first_air_date,f=d?void 0:n.seasons.filter(r=>r.season_number>0&&r.air_date!=null&&(r.episode_count??0)>0).map(r=>({number:r.season_number,name:r.name})),x=await L(t,a,c());return{kind:d?"movie":"series",id:e,title:"title"in n?n.title:n.name,posterURL:g(n.poster_path,"poster"),cleanPosterURL:v&&g(v,"poster"),backdropURL:g(n.backdrop_path,"backdrop"),logoURL:h?g(h,"logo"):void 0,overview:n.overview,releaseDate:u,duration:(p??0)*60,seasons:f,genres:((T=n.genres)==null?void 0:T.map(r=>r.name))??[],rating:n.vote_average,status:o(n.status),relatedShows:x.map(r=>w(r))}}async function I(e,o){const[a,t]=e.split("/");return a!="tv"?[]:(await R(t,o,c())).episodes.map(s=>({id:`${e}/season=${o}&id=${s.id}`,number:s.episode_number,title:s.name,overview:s.overview,thumbnailURL:g(s.still_path,"still"),duration:s.runtime*60}))}return{fetchShowsByQuery:B,fetchShow:F,fetchEpisodes:I,fetchFeedCollections:async()=>{const e=[],o=[{type:"movie",sorting:"popularity",category:"hot",name:"Popular Movies",id:"tmdb-popular-movies"},{type:"tv",sorting:"popularity",category:"hot",name:"Popular TV Shows",id:"tmdb-popular-tv-shows"},{type:"movie",sorting:"rating",category:"recommended",name:"Top Rated Movies",id:"tmdb-top-rated-movies"},{type:"tv",sorting:"rating",category:"recommended",name:"Top Rated TV Shows",id:"tmdb-top-rated-tv-shows"},{type:"movie",sorting:"release_date",category:"new",name:"New Movies",id:"tmdb-new-movies"},{type:"tv",sorting:"release_date",category:"new",name:"New TV Shows",id:"tmdb-new-tv-shows"}];for(const a of o){const t=await j(a.type,c(),{sorting:a.sorting,maximumPages:4,minimumUserVotes:100});t.length>0&&e.push({id:a.id,name:a.name,shows:t.map(w),category:a.category})}return e},fetchTrendingShows:async()=>[]}})();
